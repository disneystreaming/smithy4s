"use strict";(self.webpackChunksmithy4s=self.webpackChunksmithy4s||[]).push([[4444],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var o=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,o,s=function(e,t){if(null==e)return{};var n,o,s={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,c=a(e,["components","mdxType","originalType","parentName"]),m=p(n),d=s,h=m["".concat(l,".").concat(d)]||m[d]||u[d]||r;return n?o.createElement(h,i(i({ref:t},c),{},{components:n})):o.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,i=new Array(r);i[0]=d;var a={};for(var l in t)hasOwnProperty.call(t,l)&&(a[l]=t[l]);a.originalType=e,a[m]="string"==typeof e?e:s,i[1]=a;for(var p=2;p<r;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},674:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>p});var o=n(7462),s=(n(7294),n(3905));const r={sidebar_label:"Compliance Tests",title:"Compliance Tests"},i=void 0,a={unversionedId:"protocols/compliance-tests",id:"protocols/compliance-tests",title:"Compliance Tests",description:"The Smithy prelude has support for compliance testing for services that use HTTP as their protocol. It is built on top of regular traits, you can read more about it over here.",source:"@site/../docs/target/jvm-2.13/mdoc/03-protocols/05-compliance-tests.md",sourceDirName:"03-protocols",slug:"/protocols/compliance-tests",permalink:"/smithy4s/docs/protocols/compliance-tests",draft:!1,editUrl:"https://github.com/disneystreaming/smithy4s/edit/main/modules/docs/src/03-protocols/05-compliance-tests.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_label:"Compliance Tests",title:"Compliance Tests"},sidebar:"tutorialSidebar",previous:{title:"Openapi",permalink:"/smithy4s/docs/protocols/simple-rest-json/openapi"},next:{title:"Deriving CLIs",permalink:"/smithy4s/docs/protocols/deriving-cli"}},l={},p=[{value:"Example specification",id:"example-specification",level:2},{value:"Testing the protocol",id:"testing-the-protocol",level:2}],c={toc:p},m="wrapper";function u(e){let{components:t,...n}=e;return(0,s.kt)(m,(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"The Smithy prelude has support for compliance testing for services that use ",(0,s.kt)("inlineCode",{parentName:"p"},"HTTP")," as their protocol. It is built on top of regular traits, you can read more about it ",(0,s.kt)("a",{parentName:"p",href:"https://awslabs.github.io/smithy/2.0/additional-specs/http-protocol-compliance-tests.html"},"over here"),"."),(0,s.kt)("p",null,"Basically, you annotate operations and/or structures (that depends on the type of test being defined) and protocol implementors can generate tests cases to ensure their implementation behaves correctly."),(0,s.kt)("p",null,"Smithy4s publishes a module that you can use to write compliance test if you're implementing a protocol. Add the following to your dependencies if you use ",(0,s.kt)("inlineCode",{parentName:"p"},"sbt"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-scala"},'\nimport smithy4s.codegen.BuildInfo._\n\nlibraryDependencies ++= Seq(\n  "com.disneystreaming.smithy4s" %% "smithy4s-compliance-tests" % smithy4sVersion.value\n)\n')),(0,s.kt)("p",null,"If you use ",(0,s.kt)("inlineCode",{parentName:"p"},"mill"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-scala"},'import smithy4s.codegen.BuildInfo._\n\ndef smithy4sIvyDeps = Agg(\n  ivy"software.amazon.smithy:smithy-protocol-test-traits:$smithyVersion"\n)\n\ndef ivyDeps = Agg(\n  ivy"com.disneystreaming.smithy4s::smithy4s-compliance-tests:${smithy4sVersion()}"\n)\n')),(0,s.kt)("p",null,"The rest of this document will demonstrate how to write a Smithy specification that specify HTTP compliance tests, and then how to use the module mentioned above to run the tests."),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Note: currently, only ",(0,s.kt)("inlineCode",{parentName:"em"},"httprequesttests-trait")," are supported. other traits support will be integrated soon.")),(0,s.kt)("h2",{id:"example-specification"},"Example specification"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-kotlin"},'$version: "2"\n\nnamespace smithy4s.example.test\n\nuse smithy.test#httpRequestTests\nuse smithy.test#httpResponseTests\nuse alloy#simpleRestJson\n\n@simpleRestJson\nservice HelloService {\n    operations: [SayHello, Listen, TestPath]\n}\n\n@http(method: "POST", uri: "/")\n@httpRequestTests([\n    {\n        id: "say_hello",\n        protocol: simpleRestJson,\n        params: {\n            "greeting": "Hi",\n            "name": "Teddy",\n            "query": "Hello there"\n        },\n        method: "POST",\n        uri: "/",\n        queryParams: [\n            "Hi=Hello%20there"\n        ],\n        headers: {\n            "X-Greeting": "Hi",\n        },\n        body: "{\\"name\\":\\"Teddy\\"}",\n        bodyMediaType: "application/json"\n    }\n])\n@httpResponseTests([\n    {\n        id: "say_hello"\n        protocol: simpleRestJson\n        params: { payload: { result: "Hello!" }, header1: "V1" }\n        body: "{\\"result\\":\\"Hello!\\"}"\n        headers: { "X-H1": "V1"}\n        code: 200\n    }\n])\noperation SayHello {\n    input: SayHelloInput,\n    output: SayHelloOutput\n    errors: [SimpleError, ComplexError]\n}\n\n@input\nstructure SayHelloInput {\n    @httpHeader("X-Greeting")\n    greeting: String,\n\n    @httpQuery("Hi")\n    query: String,\n\n    name: String\n}\n\nstructure SayHelloOutput {\n    @required\n    @httpPayload\n    payload: SayHelloPayload\n\n    @required\n    @httpHeader("X-H1")\n    header1: String\n}\nstructure SayHelloPayload {\n    @required\n    result: String\n}\n\n\n@http(method: "GET", uri: "/listen")\n@readonly\n@httpRequestTests([\n    {\n        id: "listen",\n        protocol: simpleRestJson,\n        method: "GET",\n        uri: "/listen"\n    }\n])\noperation Listen { }\n\n@http(method: "GET", uri: "/test-path/{path}")\n@readonly\n@httpRequestTests([\n    {\n        id: "TestPath",\n        protocol: simpleRestJson,\n        method: "GET",\n        uri: "/test-path/sameValue"\n        params: { path: "sameValue" }\n    }\n])\noperation TestPath {\n    input := {\n        @httpLabel\n        @required\n        path: String\n    }\n}\n\n// The following shapes are used by the documentation\n@simpleRestJson\nservice HelloWorldService {\n  version: "1.0.0",\n  operations: [Hello]\n}\n@httpRequestTests([\n    {\n        id: "helloSuccess"\n        protocol: simpleRestJson\n        method: "POST"\n        uri: "/World"\n        params: { name: "World" }\n    },\n    {\n        id: "helloFails"\n        protocol: simpleRestJson\n        method: "POST"\n        uri: "/fail"\n        params: { name: "World" }\n    }\n])\n@http(method: "POST", uri: "/{name}", code: 200)\noperation Hello {\n  input := {\n    @httpLabel\n    @required\n    name: String\n  },\n  output := {\n    @required\n    message: String\n  }\n}\n\n@httpResponseTests([\n    {\n        id: "simple_error"\n        protocol: simpleRestJson\n        params: { expected: -1 }\n        code: 400\n        body: "{\\"expected\\":-1}"\n        bodyMediaType: "application/json"\n        requireHeaders: ["X-Error-Type"]\n    }\n])\n@error("client")\nstructure SimpleError {\n    @required\n    expected: Integer\n}\n@httpResponseTests([\n    {\n        id: "complex_error"\n        protocol: simpleRestJson\n        params: { value: -1, message: "some error message", details: { date: 123, location: "NYC"} }\n        code: 504\n        body: "{\\"value\\":-1,\\"message\\":\\"some error message\\",\\"details\\":{\\"date\\":123,\\"location\\":\\"NYC\\"}}"\n        bodyMediaType: "application/json"\n        requireHeaders: ["X-Error-Type"]\n    },\n    {\n        id: "complex_error_no_details"\n        protocol: simpleRestJson\n        params: { value: -1, message: "some error message" }\n        code: 504\n        body: "{\\"value\\":-1,\\"message\\":\\"some error message\\"}"\n        bodyMediaType: "application/json"\n        requireHeaders: ["X-Error-Type"]\n    }\n])\n@error("server")\n@httpError(504)\nstructure ComplexError {\n    @required\n    value: Integer\n    @required\n    message: String\n    details: ErrorDetails\n}\n\nstructure ErrorDetails {\n    @required\n    @timestampFormat("epoch-seconds")\n    date: Timestamp\n    @required\n    location: String\n}\n')),(0,s.kt)("p",null,"We have a very simple specification: one operation with basic input and output shapes. We've added a ",(0,s.kt)("inlineCode",{parentName:"p"},"httpRequestTests")," to define a compliance test for protocol implementors."),(0,s.kt)("h2",{id:"testing-the-protocol"},"Testing the protocol"),(0,s.kt)("p",null,"The service in the specification is annotated with the ",(0,s.kt)("inlineCode",{parentName:"p"},"alloy#simpleRestJson")," protocol definition. We'll use the ",(0,s.kt)("inlineCode",{parentName:"p"},"compliance-tests")," module to make sure this protocol can handle such an operation."),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Note: the following code and the ",(0,s.kt)("inlineCode",{parentName:"em"},"compliance-tests")," module do not depend on a specific test framework. If you want to hook it into your test framework, it is easy to do so but it's outside the scope of this document. Refer to ",(0,s.kt)("a",{parentName:"em",href:"https://github.com/disneystreaming/smithy4s/blob/816ac1ef2b12cc4cd2e9d795dba0d817728a3ec0/modules/compliance-tests/test/src/smithy4s/compliancetests/WeaverComplianceTest.scala"},"this example")," to see how we did it for ",(0,s.kt)("inlineCode",{parentName:"em"},"Weaver")," in this project.")),(0,s.kt)("p",null,"First, some imports:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-scala"},"import cats.effect._\nimport org.http4s._\nimport org.http4s.client.Client\nimport smithy4s.compliancetests._\nimport smithy4s.example.test._\nimport smithy4s.http.HttpMediaType\nimport smithy4s.http4s._\nimport smithy4s.kinds._\nimport smithy4s.Service\nimport smithy4s.schema.Schema\n")),(0,s.kt)("p",null,"Then, you can create and instance of ",(0,s.kt)("inlineCode",{parentName:"p"},"ClientHttpComplianceTestCase")," and/or ",(0,s.kt)("inlineCode",{parentName:"p"},"ServerHttpComplianceTestCase")," while selecting the protocol to use and the service to test:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-scala"},'object SimpleRestJsonIntegration extends Router[IO] with ReverseRouter[IO] {\n    type Protocol = alloy.SimpleRestJson\n    val protocolTag = alloy.SimpleRestJson\n\n    def expectedResponseType(schema: Schema[_]) = HttpMediaType("application/json")\n\n    def routes[Alg[_[_, _, _, _, _]]](\n        impl: FunctorAlgebra[Alg, IO]\n    )(implicit service: Service[Alg]): Resource[IO, HttpRoutes[IO]] =\n      SimpleRestJsonBuilder(service).routes(impl).resource\n\n    def reverseRoutes[Alg[_[_, _, _, _, _]]](app: HttpApp[IO],testHost: Option[String] = None)(implicit\n        service: Service[Alg]\n    ): Resource[IO, FunctorAlgebra[Alg, IO]] = {\n      import org.http4s.implicits._\n      val baseUri = uri"http://localhost/"\n      val suppliedHost = testHost.map(host => Uri.unsafeFromString(s"http://$host"))\n      SimpleRestJsonBuilder(service)\n        .client(Client.fromHttpApp(app))\n        .uri(suppliedHost.getOrElse(baseUri))\n        .resource\n    }\n  }\n\nval tests: List[ComplianceTest[IO]] = HttpProtocolCompliance\n    .clientAndServerTests(SimpleRestJsonIntegration, HelloWorldService)\n')),(0,s.kt)("p",null,"Now, you can iterate over the test cases and do what you want. This is where you would hook in the test framework of your choice, but in the following example, we're just going to print the result:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-scala"},'import cats.syntax.traverse._\nimport cats.effect.unsafe.implicits.global\n\nval runTests: IO[List[String]] = tests\n  .map { tc =>\n    tc.run.map(_.toEither).map {\n      case Left(value) =>\n        s"Failed ${tc.show} with the following message: $value"\n      case Right(_) => s"Success ${tc.show}"\n\n    }\n  }\n  .sequence\n')),(0,s.kt)("p",null,"Will produce the following when executed:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'Success smithy4s.example.test#Hello(client|Request): helloSuccess\nFailed smithy4s.example.test#Hello(client|Request): helloFails with the following message: NonEmptyList(path test : the result value: \x1b[33mVector\x1b[39m(\x1b[32m"World"\x1b[39m) was not equal to the expected TestCase value \x1b[33mVector\x1b[39m(\x1b[32m"fail"\x1b[39m).)\nSuccess smithy4s.example.test#Hello(server|Request): helloSuccess\nFailed smithy4s.example.test#Hello(server|Request): helloFails with the following message: NonEmptyList( the result value: \x1b[33mHelloInput\x1b[39m(name = \x1b[32m"fail"\x1b[39m) was not equal to the expected TestCase value \x1b[33mHelloInput\x1b[39m(name = \x1b[32m"World"\x1b[39m).)\n')))}u.isMDXComponent=!0}}]);